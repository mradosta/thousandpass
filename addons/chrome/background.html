<html>
	<head>

	<script>

		var addTo1000PassAuto = function(info, tab) {
			var answer = confirm ('Ha completado ya los campos de usuario y contraseña?')
			if (answer) {
				chrome.tabs.sendRequest(tab.id, 'add_to_1000pass_auto');
			}
		};

		var addTo1000PassManual = function(info, tab) {
			var answer = confirm ('Ha completado ya los campos de usuario y contraseña?')
			if (answer) {
				chrome.tabs.sendRequest(tab.id, 'add_to_1000pass_manual');
			}
		};


		chrome.contextMenus.create({
			"title"		: 'Agregar (Automatico)',
			"type" 		: 'normal',
			"contexts" 	: ['all'],
			"onclick"	: addTo1000PassAuto
		});
		chrome.contextMenus.create({
			"title"		: 'Agregar (Manual)',
			"type" 		: 'normal',
			"contexts" 	: ['all'],
			"onclick"	: addTo1000PassManual
		});


		chrome.browserAction.onClicked.addListener(
			function(tab) {
				chrome.tabs.create({'url':'http://www.1000pass.com'});
			}
		);

		var openedTabs = new Array();


		chrome.tabs.onRemoved.addListener(function(tabId) {
			for (var i = 0; i < openedTabs.length; i++) {
				if (openedTabs[i].tab_id == tabId) {
					openedTabs.splice(i, 1);
					break;
				}
			}
		});


		chrome.extension.onConnect.addListener(function(port) {

			port.onMessage.addListener(function(data) {

				if (port.name == 'finish_adding') {

					var xhr = new XMLHttpRequest();
					xhr.open('POST', 'http://www.1000pass.com/sites_users/extension_add', true);
					//xhr.open('POST', 'http://localhost/thousandpass/sites_users/extension_add', true);
					xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=ISO-8859-1');
					xhr.onreadystatechange = function() {
						if (xhr.readyState == 4) {
							if (xhr.responseText == 'ok') {
								alert('El sitio se agrego correctamente a su cuenta 1000pass.com');
							} else if (xhr.responseText == 'er') {
								alert('No fue posible agregar el nuevo sitio a su cuenta 1000pass.com. Verifique que su sesion en 1000pass.com este activa');
							} else if (xhr.responseText == 'du') {
								alert('El sitio que intenta agregar ya existe en su cuenta de 1000pass.com');
							}
						}
					}
					var d = 'title=' + port.tab.title + '&login_url=' + port.tab.url.replace(/&/g, '**||**') + '&logo=' + port.tab.favIconUrl + '&username_field=' + data[0] + '&extra_field=' + data[1] + '&password_field=' + data[2] + '&submit=' + data[3];

					xhr.send(d);

				} else if (port.name == 'go') {

					/** Find already opened tabs */
					var toCloseTab = false;
					var toFocusTab = false;
					for (var i = 0; i < openedTabs.length; i++) {
						if (openedTabs[i].id == data.id) {
							toFocusTab = openedTabs[i].tab_id;
							break;
						} else if (openedTabs[i].url == data.url) {
							toCloseTab = openedTabs[i].tab_id;
							break;
						}
					}


					/** If logout url is given, call this to close session before starting a new one */
					if (toCloseTab && data.logout_url != '') {

						//"There is an already opened " + data.title + ". Do you want to continue and close it?
						var answer = confirm ('Existe un sitio abierto para ' + data.title + '. Desea continuar y cerrarlo?.')
						if (answer) {
							if (data.logout_type == 'scrap') {

								chrome.tabs.sendRequest(openedTabs[i].tab_id, {},
									function(response) {
										var logout_url = data.logout_url + response.html.split(data.logout_url).pop().replace('\'', '"').split('"').shift();

										var xhr = new XMLHttpRequest();
										xhr.open('GET', logout_url, true);
										xhr.onreadystatechange = function() {
											if (xhr.readyState == 4) {

												chrome.tabs.remove(toCloseTab);
												openedTabs.splice(i, 1);

												chrome.tabs.create({'url':data.url}, function(tab) {
													data.tab_id = tab.id;
													openedTabs.push(data);
												});
											}
										}
										xhr.send();
									}
								);

							} else {
								var xhr = new XMLHttpRequest();
								xhr.open('GET', data.logout_url, true);
								xhr.onreadystatechange = function() {
									if (xhr.readyState == 4) {

										chrome.tabs.remove(toCloseTab);
										openedTabs.splice(i, 1);

										chrome.tabs.create({'url':data.url}, function(tab) {
											data.tab_id = tab.id;
											openedTabs.push(data);
										});
									}
								}
								xhr.send();
							}
						}
					} else if (toFocusTab) {
						chrome.tabs.update(toFocusTab, {selected : true});
					} else {
						chrome.tabs.create({'url':data.url}, function(tab) {
							data.tab_id = tab.id;
							data.state = 'opening';
							openedTabs.push(data);
						});
					}
				} else if (port.name == 'done') {
					for (var i = 0; i < openedTabs.length; i++) {
						if (openedTabs[i].id == data.id) {
							openedTabs[i].state = 'opened';
						}
					}
				}
			});
		});



		chrome.tabs.onUpdated.addListener(function (tabId, info, tab) {
			if (info.status == 'complete') {
				for (var i = 0; i < openedTabs.length; i++) {
					if (openedTabs[i].tab_id == tabId) {
						var port = chrome.tabs.connect(tabId);
						port.postMessage(openedTabs[i]);
					}
				}
			}
		});
		</script>
		
		<script src="jquery.js" type="text/javascript"></script>
		<script src="1000pass.js" type="text/javascript"></script>


	</head>

	<body></body>
</html>